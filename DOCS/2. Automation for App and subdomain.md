# Automation Steps for Node.js App Deployment and Tunnel Setup

This document outlines the automation steps for deploying a Node.js application and configuring a tunnel for external access in the local-consumer project. The process involves launching a virtual machine (VM), setting up a demo Node.js application, and configuring a tunnel using Cloudflare.

## Prerequisites

Before proceeding, ensure that you have the following:

- A working installation of Node.js and npm.
- Access to the Arrakis server for VM management.
- Cloudflare account with tunnel setup permissions.

## Steps

### 1. Launching a Virtual Machine (VM)

To launch a VM, the `launchVMWithAutomation` method in the `VMConsumer` class is used. This method performs the following actions:

- **Create VM Configuration**: The VM configuration is created using default values from the environment variables or provided configurations.
- **Send Launch Request**: A POST request is sent to the Arrakis server to create the VM.
- **Retrieve VM Information**: The response includes the VM's IP address and status.

### 2. Setting Up the Demo Node.js Application

Once the VM is launched, the demo Node.js application is set up using the `setupDemoApp` method. This involves:

- **Creating Application Content**: The application code is defined, which serves a simple HTML page displaying the VM's name and IP address.
- **Uploading Application Files**: The application code is uploaded to the VM using a POST request to the Arrakis server.
- **Starting the Application**: The application is started by executing a command on the VM to run the Node.js server.

### 3. Configuring the Tunnel

After the demo application is running, the tunnel is configured to allow external access. This is done using the `setupTunnel` method, which includes the following steps:

- **Generate Subdomain**: A subdomain is created based on the VM name and the base domain specified in the environment variables.
- **Update Tunnel Configuration**: The tunnel configuration file is read, and a new ingress entry is added for the subdomain.
- **Create DNS Record**: A command is executed to create a DNS record for the subdomain using Cloudflare's tunnel command.
- **Restart Cloudflared Service**: The Cloudflared service is restarted to apply the new configuration.
- **Verify Tunnel Connectivity**: A connectivity test is performed to ensure that the tunnel is accessible.

### 4. Cleanup

When the VM is no longer needed, it can be deleted using the `deleteVMWithCleanup` method, which also cleans up the tunnel configuration and DNS records.

## Conclusion

Following these steps will automate the deployment of a Node.js application on a VM and set up a tunnel for external access. Ensure to monitor the logs for any errors during the process and verify that the application is accessible via the configured subdomain.