# Arrakis VM Cloudflare Tunnel Setup Guide

This guide shows how to expose applications running inside Arrakis VMs to the internet using Cloudflare Tunnels.

## Prerequisites

- Running Arrakis VM
- Cloudflare account with domain
- Cloudflare tunnel already created (`arrakis-vm-tunnel`)
- `cloudflared` installed on host machine

## Quick Setup Overview

1. **SSH into VM** → Create/run your application
2. **Update tunnel config** → Route traffic to VM
3. **Add DNS record** → Point subdomain to tunnel
4. **Start tunnel** → Go live!



## step-by-Step Instructions

### **Step 1: Access Your Arrakis VM**

```bash
# SSH into the VM (get IP from arrakis-client list)
ssh elara@10.20.1.2

# Default credentials
Username: elara
Password: elara0000
```

### **Step 2: Create Your Demo Application**

Inside the VM, create a simple web application:

```bash
# Create a simple Node.js app
mkdir ~/demo-app && cd ~/demo-app

# Create package.json
cat > package.json << EOF
{
  "name": "arrakis-demo",
  "version": "1.0.0",
  "main": "app.js",
  "scripts": {
    "start": "node app.js"
  }
}
EOF

# Create the application
cat > app.js << EOF
const http = require('http');
const os = require('os');

const server = http.createServer((req, res) => {
  res.writeHead(200, {'Content-Type': 'text/html'});
  res.end(\`
    <!DOCTYPE html>
    <html>
    <head>
        <title>Arrakis VM Demo</title>
    </head>
    <body>
        <div class="container">
            <h1>Hello from Arrakis VM!</h1>
            <div class="info">
                <p><strong>VM Name:</strong> <span class="highlight">${vmName}</span></p>
                <p><strong>VM IP:</strong> <span class="highlight">${vmIP}</span></p>
                <p><strong>Hostname:</strong> <span class="highlight">\${os.hostname()}</span></p>
            </div>
        </div>
    </body>
    </html>
  \`);
});

server.listen(3000, '0.0.0.0', () => {
  console.log('Demo server running on port 3000');
});
EOF

# Start the application
nohup node app.js > app.log 2>&1 &

# Verify it's running
curl http://localhost:3000
```

### **Step 3: Update Cloudflare Tunnel Configuration**

On your **host machine** (not inside the VM), update the tunnel config:

```bash
# Edit the tunnel configuration
nano ~/.cloudflared/config.yml
```

Add or update the ingress rules:

```yaml
tunnel: arrakis-vm-tunnel
credentials-file: /path/to/your/credentials.json

ingress:
  # Route for your VM application
  - hostname: vm1.sandbox.puku.sh
    service: http://10.20.1.2:3000  # VM IP and app port
  
  # VS Code Server (if using)
  - hostname: vscode1.sandbox.puku.sh
    service: http://10.20.1.2:8080
  
  # Additional VM routes
  - hostname: vm2.sandbox.puku.sh
    service: http://10.20.1.3:3000  # Second VM if needed
    
  # Catch-all rule (required)
  - service: http_status:404
```

### **Step 4: Create DNS Record**

```bash
# Add DNS record pointing subdomain to your tunnel
cloudflared tunnel route dns arrakis-vm-tunnel vm1.sandbox.puku.sh

# For VS Code Server (optional)
cloudflared tunnel route dns arrakis-vm-tunnel vscode1.sandbox.puku.sh

# For additional VMs (optional)
cloudflared tunnel route dns arrakis-vm-tunnel vm2.sandbox.puku.sh
```

### **Step 5: Start the Tunnel**

```bash
# Run the tunnel daemon
cloudflared tunnel run arrakis-vm-tunnel

# Or run in background
nohup cloudflared tunnel run arrakis-vm-tunnel > tunnel.log 2>&1 &
```



## Access Your Application

Your application should now be accessible at:
```
https://vm1.sandbox.puku.sh
```

## Useful Commands

### **Check VM Status**
```bash
# List all VMs and their IPs
./arrakis-client list-all

# Get specific VM info
./arrakis-client list -n your-vm-name
```

### **Monitor Applications**
```bash
# SSH into VM and check processes
ssh elara@10.20.1.2
ps aux | grep node

# Check application logs
tail -f ~/demo-app/app.log
```

### **Tunnel Management**
```bash
# Check tunnel status
cloudflared tunnel info arrakis-vm-tunnel

# List all tunnels
cloudflared tunnel list

# View tunnel logs
tail -f tunnel.log
```



## Multiple VMs Setup

For multiple VMs, repeat the process:

1. **Create VM:** `./arrakis-client start -n vm2`
2. **Get VM IP:** `./arrakis-client list -n vm2`
3. **SSH and deploy app:** `ssh elara@NEW_VM_IP`
4. **Update config:** Add new hostname → service mapping
5. **Add DNS:** `cloudflared tunnel route dns arrakis-vm-tunnel vm2.sandbox.puku.sh`
6. **Restart tunnel:** The tunnel picks up config changes automatically



## Troubleshooting

### **Application not accessible:**
- Check if app is running: `curl http://localhost:3000` (from inside VM)
- Verify VM IP is correct in tunnel config
- Ensure DNS record was created successfully
- Check tunnel logs for errors

### **Common Issues:**
- **Connection refused:** App not listening on `0.0.0.0` (use `0.0.0.0`, not `127.0.0.1`)
- **503 errors:** Wrong VM IP or port in tunnel config
- **DNS issues:** Wait 2-3 minutes for DNS propagation

### **Debug Commands:**
```bash
# Test connectivity from host to VM
ping 10.20.1.2
telnet 10.20.1.2 3000

# Check tunnel connectivity
cloudflared access tcp --hostname vm1.sandbox.puku.sh --url localhost:8080
```



## Conclusion

You now have:
- Secure application running in Arrakis VM
- Internet access via Cloudflare Tunnel
- Custom domain with SSL/TLS
- Zero firewall configuration needed

Perfect for AI agent development, testing, and secure application deployment! 



## Pro Tips

- **Port Mapping:** Use Arrakis's automatic port forwarding for easier access
- **SSL Certs:** Cloudflare provides automatic SSL certificates
- **Multiple Apps:** Run multiple services on different ports in the same VM
- **Snapshots:** Take VM snapshots before major changes
- **Monitoring:** Use Cloudflare Analytics to monitor traffic